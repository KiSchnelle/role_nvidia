---
- name: Remove ppa repo.
  ansible.builtin.apt_repository:
    repo: ppa:graphics-drivers/ppa
    state: absent


- name: Add pin file to /etc/apt/preferences.d
  ansible.builtin.copy:
    src: "cuda.pin"
    dest: "/etc/apt/preferences.d/cuda-repository-pin-600"
    owner: "root"
    group: "root"
    mode: "0644"


- name: Add apt key.
  ansible.builtin.apt_key:
    url: "https://developer.download.nvidia.com/compute/cuda/repos/{{ ansible_distribution | lower }}{{ ansible_distribution_version | replace('.', '') }}/{{ ansible_architecture }}/7fa2af80.pub"
    id: "7fa2af80"


- name: Add cuda repo
  apt_repository:
    repo: "deb http://developer.download.nvidia.com/compute/cuda/repos/{{ ansible_distribution | lower }}{{ ansible_distribution_version | replace('.', '') }}/{{ ansible_architecture }} /"
    update_cache: yes


- name: Check if nvidia-smi is available.
  ansible.builtin.shell: nvidia-smi
  register: nvidia_installed
  ignore_errors: true
  changed_when: false


- name: Install nvidia drivers.
  ansible.builtin.apt:
    name: 'cuda-drivers-{{ driver_version }}'
    state: present
    autoremove: true
    update_cache: true


- name: Unload nvidia modules.
  community.general.modprobe:
    name: "{{ item }}"
    state: absent
  with_items:
    - "nvidia_uvm"
    - "nvidia_drm"
    - "nvidia_modeset"
    - "nvidia"
  when: nvidia_installed is not failed


- name: Call nvidia-smi.
  ansible.builtin.shell: nvidia-smi
  register: nvidia_smi_output


- name: Print nvidia-smi output.
  ansible.builtin.debug:
    msg: "{{ nvidia_smi_output.stdout_lines }}"